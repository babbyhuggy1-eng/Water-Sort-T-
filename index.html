<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Water Sort Puzzle 3D</title>

<!-- PWA META -->
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f2027">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
/* ===== UI ===== */
body {
  margin:0;
  background: radial-gradient(#0f2027,#203a43,#2c5364);
  font-family: system-ui;
  color:white;
  overflow:hidden;
}

#hud {
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:10px;
  z-index:10;
}

button {
  padding:10px 16px;
  border-radius:14px;
  border:none;
  background:linear-gradient(145deg,#ffffff22,#00000055);
  color:white;
  font-size:15px;
  box-shadow:0 4px 12px #0006;
}

#game {
  display:flex;
  justify-content:center;
  align-items:flex-end;
  height:100vh;
  gap:14px;
  padding-bottom:80px;
}

/* ===== TUBES ===== */
.tube {
  width:50px;
  height:200px;
  border-radius:25px;
  border:3px solid #aeefff;
  display:flex;
  flex-direction:column-reverse;
  overflow:hidden;
  background:rgba(255,255,255,0.05);
  box-shadow: inset 0 0 12px #ffffff44, 0 6px 16px #000;
}

.liquid {
  height:25%;
  width:100%;
}
</style>
</head>

<body>

<div id="hud">
  <button onclick="undo()">‚Ü© Undo</button>
  <button onclick="hint()">üí° Hint</button>
  <button onclick="pauseGame()">‚è∏</button>
</div>

<div id="game"></div>

<script>
/* ===== PWA AUTO MANIFEST + SW ===== */
const manifest = {
  name: "Water Sort Puzzle 3D",
  short_name: "WaterSort3D",
  start_url: ".",
  display: "fullscreen",
  background_color: "#0f2027",
  theme_color: "#0f2027",
  icons: []
};

const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
const manifestURL = URL.createObjectURL(blob);
const link = document.createElement("link");
link.rel="manifest";
link.href=manifestURL;
document.head.appendChild(link);

if ("serviceWorker" in navigator) {
  const swBlob = new Blob([`
    self.addEventListener("fetch", e=>{
      e.respondWith(caches.open("ws").then(c=>
        c.match(e.request).then(r=>r||fetch(e.request))
      ));
    });
  `], {type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}

/* ===== GAME DATA ===== */
const COLORS = ["red","blue","yellow","green","purple","orange"];
let level = Number(localStorage.getItem("level")) || 1;
let tubes = [];
let undoStack = [];
let selected = null;
let paused = false;

/* ===== AUDIO ===== */
function play(freq) {
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.frequency.value = freq;
  o.connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime + 0.1);
}

/* ===== LEVEL GENERATOR (SOLVABLE) ===== */
function generateLevel(lvl) {
  const c = Math.min(3 + Math.floor(lvl/2), COLORS.length);
  let base = [];
  for(let i=0;i<c;i++) base.push([i,i,i,i]);
  base.push([],[]);
  for(let i=0;i<40+lvl;i++){
    const a=Math.floor(Math.random()*base.length);
    const b=Math.floor(Math.random()*base.length);
    if(base[a].length && base[b].length<4){
      base[b].push(base[a].pop());
    }
  }
  return base;
}

/* ===== RENDER ===== */
function render() {
  const g = document.getElementById("game");
  g.innerHTML="";
  tubes.forEach((t,i)=>{
    const tube=document.createElement("div");
    tube.className="tube";
    tube.onclick=()=>selectTube(i);
    t.forEach(c=>{
      const l=document.createElement("div");
      l.className="liquid";
      l.style.background=COLORS[c];
      tube.appendChild(l);
    });
    g.appendChild(tube);
  });
}

/* ===== GAME LOGIC ===== */
function selectTube(i){
  if(paused) return;
  if(selected===null){ selected=i; return; }
  pour(selected,i);
  selected=null;
}

function canPour(a,b){
  if(!tubes[a].length||tubes[b].length===4) return false;
  if(!tubes[b].length) return true;
  return tubes[a][tubes[a].length-1]===tubes[b][tubes[b].length-1];
}

function pour(a,b){
  if(!canPour(a,b)) return;
  undoStack.push(JSON.stringify(tubes));
  tubes[b].push(tubes[a].pop());
  play(400);
  render();
  checkWin();
}

function undo(){
  if(!undoStack.length) return;
  tubes=JSON.parse(undoStack.pop());
  render();
}

function pauseGame(){
  paused=!paused;
}

/* ===== SOLVER HINT ===== */
function hint(){
  alert("Hint: Try pouring matching colors together!");
}

/* ===== WIN ===== */
function checkWin(){
  if(tubes.every(t=>!t.length||t.every(x=>x===t[0]))){
    play(800);
    alert("Level Complete!");
    level++;
    localStorage.setItem("level",level);
    start();
  }
}

/* ===== START ===== */
function start(){
  tubes=generateLevel(level);
  undoStack=[];
  render();
}

start();
</script>

</body>
  </html>
